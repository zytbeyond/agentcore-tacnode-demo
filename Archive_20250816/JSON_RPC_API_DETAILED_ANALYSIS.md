# üîç JSON-RPC API Detailed Analysis: AgentCore ‚Üí Gateway ‚Üí TACNode

## üìã **Complete Data Flow and API Transfer Analysis**

This document provides a detailed breakdown of what happens at each step in the JSON-RPC communication chain from AgentCore Runtime to TACNode Context Lake.

---

## üåâ **Complete Architecture Flow**

```
User Question ‚Üí AgentCore Runtime ‚Üí AgentCore Gateway ‚Üí TACNode MCP Server ‚Üí PostgreSQL
                    ‚Üì                      ‚Üì                    ‚Üì
               Docker Container        JSON-RPC API        SQL Commands
               (Python Agent)         (MCP Protocol)      (Database Queries)
```

---

## üìä **1. USER TO AGENTCORE RUNTIME**

### **Input: User Question**
```json
{
  "input": {
    "prompt": "What is our total business value and which category is performing best?"
  }
}
```

### **AgentCore Runtime Processing:**
- **Who**: Docker container running our Python agent (`business-intelligence-agent`)
- **Where**: AWS Bedrock AgentCore Runtime (`TACNodeBusinessIntelligenceAgent-WyUKPc8jfZ`)
- **What**: Agent analyzes question for business keywords

### **Agent Decision Logic:**
```python
business_keywords = ['business', 'value', 'category', 'performance']
needs_data = any(keyword in user_question.lower() for keyword in business_keywords)
# Result: needs_data = True ‚Üí Agent will call AgentCore Gateway
```

---

## üåâ **2. AGENTCORE RUNTIME ‚Üí AGENTCORE GATEWAY**

### **Who Generates JSON-RPC**: 
**Docker container in AgentCore Runtime** (our Python agent code)

### **JSON-RPC Request Generated by Agent:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "get_business_data",
    "arguments": {
      "query_type": "business_summary",
      "context": "total business value and category performance"
    }
  }
}
```

### **HTTP Request to AgentCore Gateway:**
```http
POST /mcp HTTP/1.1
Host: agentcore-gateway-endpoint
Content-Type: application/json
Authorization: Bearer <gateway-token>

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "get_business_data",
    "arguments": {
      "query_type": "business_summary",
      "context": "total business value and category performance"
    }
  }
}
```

### **What AgentCore Gateway Receives:**
- **Protocol**: JSON-RPC 2.0 over HTTP
- **Method**: `tools/call` (MCP standard)
- **Tool Name**: `get_business_data`
- **Arguments**: Query context and type
- **Source**: AgentCore Runtime container

---

## üéØ **3. AGENTCORE GATEWAY ‚Üí TACNODE CONTEXT LAKE**

### **Who Processes**: 
**AgentCore Gateway** (AWS managed service)

### **Gateway Processing:**
1. **Receives**: JSON-RPC from AgentCore Runtime
2. **Validates**: Authentication and permissions
3. **Routes**: To configured TACNode target
4. **Transforms**: Request for TACNode MCP server

### **JSON-RPC Request to TACNode:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "execute_sql",
    "arguments": {
      "query": "SELECT id, name, description, value, category, created_date, is_active FROM test WHERE is_active = true ORDER BY created_date DESC"
    }
  }
}
```

### **HTTP Request to TACNode MCP Server:**
```http
POST https://mcp-server.tacnode.io/mcp HTTP/1.1
Content-Type: application/json
Authorization: Bearer <tacnode-token>

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "execute_sql",
    "arguments": {
      "query": "SELECT id, name, description, value, category, created_date, is_active FROM test WHERE is_active = true ORDER BY created_date DESC"
    }
  }
}
```

### **What TACNode Receives:**
- **Protocol**: JSON-RPC 2.0 over HTTPS
- **Method**: `tools/call`
- **Tool**: `execute_sql`
- **SQL Query**: Actual PostgreSQL command
- **Source IP**: AWS us-east-1 range (whitelisted)

---

## üóÑÔ∏è **4. TACNODE ‚Üí POSTGRESQL DATABASE**

### **Who Executes SQL**: 
**TACNode MCP Server** (tacnode.io infrastructure)

### **SQL Command Executed:**
```sql
SELECT 
    id, 
    name, 
    description, 
    value, 
    category, 
    created_date, 
    is_active 
FROM test 
WHERE is_active = true 
ORDER BY created_date DESC;
```

### **Database Response:**
```sql
-- Results: 10 rows returned
id | name     | description        | value  | category   | created_date | is_active
1  | Sample A | First test record  | 123.45 | Category 1 | 2025-07-20   | true
2  | Sample B | Second test record | 456.78 | Category 2 | 2025-07-21   | true
...
10 | Sample J | Latest record      | 111.11 | Category 1 | 2025-08-04   | true
```

---

## üì§ **5. RETURN PATH: POSTGRESQL ‚Üí TACNODE ‚Üí GATEWAY ‚Üí RUNTIME**

### **TACNode MCP Response:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "[{\"id\":1,\"name\":\"Sample A\",\"description\":\"First test record\",\"value\":\"123.45\",\"category\":\"Category 1\",\"created_date\":\"2025-07-20\",\"is_active\":true},{\"id\":2,\"name\":\"Sample B\",\"description\":\"Second test record\",\"value\":\"456.78\",\"category\":\"Category 2\",\"created_date\":\"2025-07-21\",\"is_active\":true}...]"
      }
    ]
  }
}
```

### **AgentCore Gateway Response to Runtime:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "[{\"id\":1,\"name\":\"Sample A\",\"description\":\"First test record\",\"value\":\"123.45\",\"category\":\"Category 1\",\"created_date\":\"2025-07-20\",\"is_active\":true}...]"
      }
    ]
  }
}
```

### **Agent Processing in Runtime:**
```python
# Agent receives JSON-RPC response
response_data = json.loads(response_text)
business_records = json.loads(response_data['result']['content'][0]['text'])

# Calculate business metrics
total_value = sum(float(record['value']) for record in business_records)
categories = {}
for record in business_records:
    category = record['category']
    if category not in categories:
        categories[category] = {'count': 0, 'total': 0}
    categories[category]['count'] += 1
    categories[category]['total'] += float(record['value'])

# Generate business intelligence
top_category = max(categories.items(), key=lambda x: x[1]['total'])
```

---

## üìä **DETAILED JSON-RPC TRANSFERS**

### **üîç What's Transferred at Each Step:**

| Step | From | To | Protocol | Data Type | Content |
|------|------|----|---------|-----------| --------|
| 1 | User | AgentCore Runtime | HTTP | JSON | User question |
| 2 | Runtime Container | AgentCore Gateway | JSON-RPC | MCP Call | `tools/call` with business query |
| 3 | AgentCore Gateway | TACNode MCP | JSON-RPC | SQL Request | `execute_sql` with SQL query |
| 4 | TACNode MCP | PostgreSQL | SQL | Database Query | `SELECT` statement |
| 5 | PostgreSQL | TACNode MCP | SQL | Result Set | 10 business records |
| 6 | TACNode MCP | AgentCore Gateway | JSON-RPC | MCP Response | JSON array of records |
| 7 | AgentCore Gateway | Runtime Container | JSON-RPC | MCP Response | Same JSON data |
| 8 | Runtime Container | Claude AI | HTTP | Prompt | Business data + user question |
| 9 | Claude AI | Runtime Container | HTTP | Response | Business intelligence analysis |
| 10 | Runtime Container | User | HTTP | JSON | Final business report |

---

## üîß **WHO GENERATES WHAT**

### **üê≥ Docker Container in AgentCore Runtime Generates:**
```python
# 1. Business keyword detection
needs_data = agent.should_access_business_data(user_question)

# 2. JSON-RPC request to gateway
gateway_request = {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
        "name": "get_business_data",
        "arguments": {"query_type": "business_summary"}
    }
}

# 3. HTTP call to AgentCore Gateway
response = await httpx.post(gateway_url, json=gateway_request)
```

### **üåâ AgentCore Gateway Generates:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "execute_sql",
    "arguments": {
      "query": "SELECT id, name, description, value, category, created_date, is_active FROM test WHERE is_active = true ORDER BY created_date DESC"
    }
  }
}
```

### **üèõÔ∏è TACNode MCP Server Generates:**
```sql
SELECT id, name, description, value, category, created_date, is_active 
FROM test 
WHERE is_active = true 
ORDER BY created_date DESC;
```

---

## üéØ **KEY INSIGHTS**

### **‚úÖ JSON-RPC Protocol Usage:**
- **Standard**: JSON-RPC 2.0 (RFC 4627)
- **Transport**: HTTP/HTTPS
- **Method**: `tools/call` (MCP standard)
- **Authentication**: Bearer tokens

### **‚úÖ Data Transformation:**
1. **User Question** ‚Üí **Business Keywords**
2. **Business Keywords** ‚Üí **JSON-RPC MCP Call**
3. **MCP Call** ‚Üí **SQL Query**
4. **SQL Results** ‚Üí **JSON Array**
5. **JSON Array** ‚Üí **Business Intelligence**

### **‚úÖ Security & Authentication:**
- **AgentCore Gateway**: AWS managed authentication
- **TACNode Access**: Bearer token authentication
- **IP Whitelisting**: AWS us-east-1 ranges
- **HTTPS**: Encrypted transport

### **‚úÖ Error Handling:**
- **JSON-RPC Errors**: Standard error responses
- **SQL Errors**: Handled by TACNode MCP
- **Network Errors**: Retry logic in agent
- **Authentication Errors**: Proper error propagation

---

## üöÄ **PRODUCTION IMPLICATIONS**

### **üìä Performance:**
- **Latency**: 7-20 seconds end-to-end
- **Data Volume**: 10 records per query
- **Caching**: Could be implemented at gateway level
- **Scaling**: Horizontal scaling via container replicas

### **üîí Security:**
- **Authentication**: Multi-layer (Gateway + TACNode)
- **Authorization**: Role-based access control
- **Encryption**: HTTPS throughout
- **Audit**: Full request/response logging

### **üîß Monitoring:**
- **JSON-RPC Metrics**: Request/response times
- **SQL Performance**: Query execution times
- **Error Rates**: Failed requests by component
- **Data Freshness**: Last update timestamps

This detailed analysis shows how JSON-RPC serves as the backbone for seamless communication between AgentCore and TACNode, enabling real-time business intelligence with proper security and error handling.
